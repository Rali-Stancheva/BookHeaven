<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/head :: head}">
    <title>Book Heaven</title>
</head>
<body>
<div th:if="${@currentUser.isLogged() and @currentUser.isAdmin()}">
    <div th:replace="~{fragments/admin-navigation :: admin-navigation}"></div>
</div>
<div th:unless="${@currentUser.isLogged() and @currentUser.isAdmin()}">
    <div th:replace="~{fragments/navigation :: navigation}"></div>
</div>


<div class="container">
    <div class="book-img">
        <!--        <img th:src="@{${book.imageUrl}}">-->
        <img th:src="@{'/uploads/' + ${book.image}}">

        <!--WANT-TO-READ BUTTON-->
        <div class="book-readed-or-for-reading" th:if="${not @currentUser.isAdmin()}">

            <div class="readed" th:if="${@currentUser.isLogged()}">
                <form th:action="@{'/books/add-to-read/' + ${@currentUser.getId()} + '/' + ${book.id}}" method="post">
                    <button type="submit" class="btn-readed-book">Read</button>
                </form>
            </div>


            <div class="readed" th:unless="${@currentUser.isLogged()}">
                <a th:href="@{/users/login}" class="btn-readed-book">Read</a>
            </div>


            <div class="for-reading" th:if="${@currentUser.isLogged()}">
                <form th:action="@{'/books/add-to-for-reading/' + ${@currentUser.getId()} + '/' + ${book.id}}"
                      method="post">
                    <button type="submit" class="btn-for-reading">For Reading</button>
                </form>
            </div>
            <div class="for-reading" th:unless="${@currentUser.isLogged()}">
                <a th:href="@{/users/login}" class="btn-for-reading">For Reading</a>
            </div>

        </div>

        <div th:if="${successMessage}" class="alert alert-success" role="alert">
            <p th:text="${successMessage}"></p>
        </div>
        <div th:if="${errorMessage != null}" class="alert alert-danger" role="alert">
            <p th:text="${errorMessage}">Error</p>
        </div>


        <!--   NEW  - RATING -->
        <p th:if="${@currentUser.isLogged() and not @currentUser.isAdmin() and averageRating != null and averageRating != 0.0}">
            Average Rating: <span th:text="${averageRating}"></span>
        </p>

        <p th:if="${@currentUser.isLogged() and not @currentUser.isAdmin() and userRating != null and userRating != 0}">
            Your Rating: <span th:text="${userRating}"></span>
        </p>

        <button type="button" class="rate-button-logged"
                th:if="${@currentUser.isLogged()} and not ${@currentUser.isAdmin()}" data-toggle="modal"
                data-target="#ratingModal">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-star"
                 viewBox="0 0 16 16">
                <path d="M2.866 14.85c-.078.444.36.791.746.593l4.39-2.256 4.389 2.256c.386.198.824-.149.746-.592l-.83-4.73 3.522-3.356c.33-.314.16-.888-.282-.95l-4.898-.696L8.465.792a.513.513 0 0 0-.927 0L5.354 5.12l-4.898.696c-.441.062-.612.636-.283.95l3.523 3.356-.83 4.73zm4.905-2.767-3.686 1.894.694-3.957a.56.56 0 0 0-.163-.505L1.71 6.745l4.052-.576a.53.53 0 0 0 .393-.288L8 2.223l1.847 3.658a.53.53 0 0 0 .393.288l4.052.575-2.906 2.77a.56.56 0 0 0-.163.506l.694 3.957-3.686-1.894a.5.5 0 0 0-.461 0z"/>
            </svg>
            Rate
        </button>

        <a th:href="@{/users/login}" class="rate-button" th:unless="${@currentUser.isLogged()}">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-star"
                 viewBox="0 0 16 16">
                <path d="M2.866 14.85c-.078.444.36.791.746.593l4.39-2.256 4.389 2.256c.386.198.824-.149.746-.592l-.83-4.73 3.522-3.356c.33-.314.16-.888-.282-.95l-4.898-.696L8.465.792a.513.513 0 0 0-.927 0L5.354 5.12l-4.898.696c-.441.062-.612.636-.283.95l3.523 3.356-.83 4.73zm4.905-2.767-3.686 1.894.694-3.957a.56.56 0 0 0-.163-.505L1.71 6.745l4.052-.576a.53.53 0 0 0 .393-.288L8 2.223l1.847 3.658a.53.53 0 0 0 .393.288l4.052.575-2.906 2.77a.56.56 0 0 0-.163.506l.694 3.957-3.686-1.894a.5.5 0 0 0-.461 0z"/>
            </svg>
            Rate
        </a>


    </div>

    <div class="book-info-container">

        <div class="admin-actions-container" th:if="${@currentUser.isLogged() and @currentUser.isAdmin()}">

            <div class="change-information-modal">
                <!-- Button trigger modal -->
                <button type="button" class="btn btn-success" data-toggle="modal" data-target="#exampleModalCenter">
                    Change
                </button>


                <!-- Modal Change Info-->
                <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog"
                     aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="exampleModalLongTitle">Change book information</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form id="editForm" th:action="@{'/books/edit/' + ${book.id}}" method="post"
                                      enctype="multipart/form-data">
                                    <label for="title">Title: </label>
                                    <input type="text" id="title" name="title" th:value="${book.title}" required><br>

                                    <label for="publicationDate">Publication Date: </label>
                                    <input type="date" id="publicationDate" name="publicationDate"
                                           th:value="${book.publicationDate}" required><br>

                                    <label for="description">Description: </label>
                                    <textarea id="description" name="description"
                                              th:text="${book.description}"></textarea><br>

                                    <label for="rating">Rating: </label>
                                    <input type="text" id="rating" name="rating" th:value="${book.rating}" required><br>


                                    <label for="author">Author: </label>
                                    <select id="author" name="authorId" class="form-control" required>
                                        <option th:each="author : ${authors}" th:value="${author.id}"
                                                th:text="${author.name}"
                                                th:selected="${author.id} == ${book.author.id}"></option>
                                    </select><br>

                                    <label for="category">Category: </label>
                                    <select id="category" name="categoryId" class="form-control" required>
                                        <option value="" disabled selected hidden>Please select a category.</option>
                                        <option th:each="category : ${allCategories}" th:value="${category.id}"
                                                th:text="${category.name}"
                                                th:selected="${category.id} == ${book.category.id}"></option>
                                    </select><br>

                                    <label for="ISBN">ISBN: </label>
                                    <input type="text" id="ISBN" name="ISBN"  th:value="${book.ISBN}" required><br>

                                    <label for="language">Language:</label><br>
                                    <input type="text" id="language" name="language" th:value="${book.language}" required><br>

                                    <label for="publisher">Publisher:</label><br>
                                    <input type="text" id="publisher" name="publisher"  th:value="${book.publisher}" required><br>

                                    <label for="file">Image:</label><br>
                                    <input type="file" id="file" name="file"/>

                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close
                                        </button>
                                        <button type="submit" class="btn btn-success">Save changes</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="delete-information-modal">
                <!-- Button trigger modal -->
                <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#deleteModalCenter">
                    Delete
                </button>


                <!-- Modal - Delete -->
                <div class="modal fade" id="deleteModalCenter" tabindex="-1" role="dialog"
                     aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="deleteModalLongTitle">Delete book</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form id="deleteForm" th:action="@{'/books/delete/' + ${book.id}}" method="post">
                                    Are you sure you want to delete this book?
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close
                                        </button>
                                        <button type="submit" class="btn btn-danger">Delete</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="book-info">
            <h1 th:text="${book.title}"></h1>
            <p>Author:
                <a th:href="@{'/authors/' + ${book.getAuthor().getId()}}">
                    <span th:text="${book.author.getName()}"></span>
                </a>
            </p>
            <p>Language: <span th:text="${book.language}"></span></p>
            <p>Publisher: <span th:text="${book.publisher}"></span></p>
            <p>ISBN: <span th:text="${book.ISBN}"></span></p>
            <p>Rating: <span th:text="${book.rating}"></span></p>
            <p th:text="${book.description}"></p>
            <div class="comments">
                <h3>Comments</h3>
                <div th:each="comment : ${commentsForBook}">
                    <p><strong th:text="${comment.user.username}">Username</strong></p>
                    <p th:text="${comment.comments}">Comment</p>
                    <p th:text="${comment.postDate}">Comment Date</p>
                    <hr>
                </div>


                <form method="post" th:action="@{'/books/comments/' + ${book.id}}"
                      th:if="${not @currentUser.isAdmin()}">
                    <textarea class="text-area-comments" id="comment" name="comment" type="text" rows="4" cols="50"
                              required></textarea>
                    <button type="submit">Send</button>
                </form>
            </div>
        </div>


    </div>
</div>


<!--Modal RATE-->
<div class="modal fade" id="ratingModal" tabindex="-1" aria-labelledby="ratingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ratingModalLabel">Rate Book</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="rating-container">
                    <form id="rating-form" th:action="@{'/books/rate/' + ${book.id}}" method="post">
                        <input type="radio" id="rating-1" name="rating" value="1">
                        <label for="rating-1">1</label>

                        <input type="radio" id="rating-2" name="rating" value="2">
                        <label for="rating-2">2</label>

                        <input type="radio" id="rating-3" name="rating" value="3">
                        <label for="rating-3">3</label>

                        <input type="radio" id="rating-4" name="rating" value="4">
                        <label for="rating-4">4</label>

                        <input type="radio" id="rating-5" name="rating" value="5">
                        <label for="rating-5">5</label>

                        <input type="radio" id="rating-6" name="rating" value="6">
                        <label for="rating-6">6</label>

                        <input type="radio" id="rating-7" name="rating" value="7">
                        <label for="rating-7">7</label>

                        <input type="radio" id="rating-8" name="rating" value="8">
                        <label for="rating-8">8</label>

                        <input type="radio" id="rating-9" name="rating" value="9">
                        <label for="rating-9">9</label>

                        <input type="radio" id="rating-10" name="rating" value="10">
                        <label for="rating-10">10</label>


                        <button type="submit" class="btn btn-secondary">Rate</button>

                    </form>

                    <form id="delete-rating-form" th:action="@{'/books/delete-rating/' + ${book.id}}" method="post">
                        <button type="submit" class="btn text-black">Delete Rating</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>


</body>
</html>